Code Signing with Fastlane Match
==============

We use [Fastlane Match](https://docs.fastlane.tools/actions/match/) to share code-signing identities across the team and CI. We have configured it to store the identities in our private git repo

We use two teams on our Apple developer center account:

1. "Enterprise" team for day-to-day developent and App Center [see](#download-and-install-code-signing-identities-on-your-machine)
2. "AppStore" team for TestFlight and AppStore [see](#testflight-and-appstore)


**Caution**

- **DO NOT** use Xcode code signing capabilities ("Download Manual Profiles" or "Manage Certificates" buttons in Xcode's preferences pane) and don't change automatic code signing in the project settings. Always use Match.
- Do not enable automatic code signing for any target in the project. Always set it to Manual and use xcconfig files to specify code signing build settings if needed
- Never use Match with `--readonly false` **unless** you need to generate/regenerate profiles. Otherwise existing builds on App Center will become invalid. By default it is run with `--readonly true`

## Download and install code signing identities on your machine

For day to day and App Center, we use certificates and profiles from our Enterprise team

1. Set a developer account that is added to Babylon's internal enterprise organization to your Xcode settings in `Preferences -> Accounts` menu. 
2. Run the following command in the terminal: 

- to download development certificates and profiles to run the app on device from Xcode:

```shell
 $ bundle exec fastlane match_development
```

- to download enterprise certificates and profiles to make enterprise build locally:

```shell
 $ bundle exec fastlane match_enterprise
```

- to download AppStore certificates and profiles to make AppStore build locally:

```shell
 $ bundle exec fastlane match_appstore
```

3. On prompt for passphrase to decrypt the repository, enter the one from 1Password vault.

To troubleshoot, refer to `fastlane/Matchfile`, `fastlane/Appfile` and [documentation](https://docs.fastlane.tools/actions/match/)

Mentioned lanes will download certificates and profiles for all the apps (and their extensions) specificed in Appfile in the `app_config`. You can specify `readonly:false` option if you want the profiles to be regenerated. Note that it will regenerate all invalid profiles for all the apps.

```
bundle exec fastlane match_enterprise readonly:false
```

If you want to work with profiles and certificates of specific application use `fastlane match` action directly and call it with all required parameters explicitly (use `bundle exec fastlane match --help` to list all the parameters):

- `--type`: the profile type, can be `appstore`, `adhoc`, `development`, `enterprise`
- `--app_identifier`: The bundle identifier(s) of your app (comma-separated)
- `--team_id`: The ID of Developer Portal team (see `team_id` in Appfile)
- `--git_branch`: Specific git branch in match repository to use (`352LTJUM25` for `appstore`, `adhoc-build` for `adhoc`, `master` for `enterprise` and `development`), default is `master`
- `--readonly false`: will generate new certificates and profiles if needed, default is `true` (meaning match will run in readonly mode and will only download existing profiles and certificates)

## Renew expired profiles

(As of June 2019, `fastlane` could not renew expired profiles automatically or using a command although the documentation mentions that it does)

- Renew the profile on Apple developer center:
  - go to "Edit" profile
  - save it without changing anything
  
- Run the following command to update match repository with new profile

To update the enterprise profile:

```shell
 $ bundle exec fastlane match enterprise --team_id {{enterprise teamID}} --app_identifier {{enterprise bundleID}} --readonly false
```

To update the AppStore profile:

```shell
 $ bundle exec fastlane match appstore --team_id {{appstore teamID}} --git_branch {{appstore teamID}} --app_identifier {{appstore bundleID}} --readonly false
```

Note: We specify `--app_identifier` so that other valid profiles are not re-generated by mistake.

## Add new device for development

- Run `bundle exec fastlane add_device` locally, it will ask you for the name of the device and its UDID, will add it to the Apple developer center for enterprise team and will automatically regenerate all development provisioning profiles.

After adding the device, the lane will ask for the bundle ids for the provisioning profiles that need to be regenerated. Check the target that you want to run, as some of them may require more than one in order to work. For example, the main target requires the notification service extension, which means that at least two provisionin profiles need to be generated.

If something goes wrong with this lane you can follow these manual steps:
- You can register your device manually on the portal in the enterprise team account
- Run the following command

```
bundle exec fastlane match development --team_id {{enterprise teamID}} --force_for_new_devices --readonly false
```

## Several Targets and Teams

- As recommended, we store identities related to different teams on different branches in our fastlane match git repository
- On `master` branch, enterprise-account (develop and App Center) related identities are stored
- On `{{AppStore team id}}` branch, Testflight & Appstore related identities (distribution) are stored
- `adhoc-build` branch is used for adhoc certificates and profiles

## Update Contents Manually

**TL;DR;**

_This is something that you should normally not need to do, except in an extraordinary situation. Consider asking for help and to do it in pair with someone to avoid making things worse. Officially, Fastlane does not recommend this approach. For the original reference for this method visit [fastlane docs](https://docs.fastlane.tools/advanced/other/#manually-manage-the-fastlane-match-repo)._

<details>
<summary>I know! Tell me more!</summary>

Apple does not allow more than two distribution certificates per account, so it can happen that fastlane match cannot create a new distribution certificate and is unable to figure out which existing certificate to link with a new provisioning profile. Fastlane match provides a utility for revoking and deleting all existing certificates and provisioning profiles and replace them with new ones generated by fastlane match. This is, however, not always advisable. Nuking existing enterprise certificates can be a really bad idea as in house apps (that is, App Center builds) will stop working. It does not affect builds submitted to TestFlight or AppStore in any way.

Since the files in the GitHub repository are encrypted they cannot be updated directly. Fastlane match provides a couple of helper functions. To clone the repository, open a ruby console and call `Match::GitHelper.clone`. Babylon specific credentials can be found in the iOS 1Password vault.

```shell
$ bundle console
irb(main):001:0> require 'match'
=> true
irb(main):002:0> branch = 'build_target'
=> "build_target"
irb(main):003:0> git_url = 'https://github.com/path/to/fastlane/match/repo'
=> "https://github.com/path/to/fastlane/match/repo"
irb(main):004:0> shallow_clone = false
=> false
irb(main):005:0> password = 'long-and-super-secret'
=> "long-and-super-secret"
irb(main):006:0> workspace = Match::GitHelper.clone(git_url, shallow_clone, manual_password: password, branch: branch)
[14:22:10]: Cloning remote git repo…
[14:22:10]: If cloning the repo takes too long, you can use the `clone_branch_directly` option in match.
[14:22:12]: Checking out branch build_target…
[14:22:12]: 🔓  Successfully decrypted certificates repo
=> "/var/folders/8k/r0x0ys_927q8vq5_tq01ntjd2b03m3/T/d20190228-92193-16w4fz2"
```
Open another terminal session and navigate to the folder name returned by `Match::GitHelper.clone`. Once all edits are complete, return to the ruby console. Beware that you must let fastlane match commit the changes that have been made. If you try to commit changes manually they will not be encrypted correctly.

```shell
irb(main):007:0> commit_message = 'Updated provisioning profiles as required.'
=> "Updated provisioning profiles as required.”
irb(main):008:> Match::GitHelper.commit_changes(workspace, commit_message, git_url, branch)
[14:28:44]: 🔒  Successfully encrypted certificates repo
[14:28:44]: Pushing changes to remote git repo…
=> nil
```

It can be convenient to store the password in the environment hash

```shell
irb(main):008:> ENV[“MATCH_PASSWORD"] = 'long-and-super-secret'
```

The password itself can be found in the iOS team 1Password vault. Note that this is the password for the encryption key, not a password for accessing iTunes connect.

Certificates are stored in three folders

```shell
 certs/development
 certs/distribution
 certs/enterprise
```

It might be necessary to manually make a certificate available in both the enterprise and distribution folder. Copying the files did not work (February 2019), but adding a soft link did.

Fastlane match expects the filename for the .p12 and .cer to be `certificate id`.p12 and `certificate id`.cer, whereas manually generated certificates that have been downloaded from the developer portal are named `team id`.cer and `team id`.p12.

## Accessing Apple Developer Portal with fastlane spaceship

Fastlane has a utility for interacting with Apple Developer Portal and the App Store Connect API called [spaceship](https://github.com/fastlane/fastlane/tree/master/spaceship).

The certificate id can be found by inspecting the certificate in the spaceship playground.

```shell
$ fastlane spaceship
…
Username: apple_developer_id@icloud.com
Logging into to iTunes Connect (apple_developer_id@icloud.com)...
Successfully logged in to iTunes Connect
Logging into the Developer Portal (apple_developer_id@icloud.com)...
Successfully logged in to the Developer Portal
---------------------------------------
| Welcome to the spaceship playground |
---------------------------------------
Enter docs to open up the documentation
Enter exit to exit the spaceship playground
Enter _ to access the return value of the last executed command
Just enter the commands and confirm with Enter
[1] pry(#<Spaceship::Playground>)> certificates = Spaceship::Portal.certificate.all
The current user is in 2 teams. Pass a team ID or call `select_team` to choose a team. Using the first one for now.
=> [<Spaceship::Portal::Certificate::Development
        id="CV89FKERTS",
        name="iOS Development",
        status="Issued",
        created=2018-03-05 20:54:38 UTC,
        expires=2019-03-05 20:44:38 UTC,
        owner_type="teamMember",
        owner_name="Latosius Silversong",
        owner_id="BH9RFFETSAS",
        type_display_id="6FG4WEDART",
        can_download=true>,
...
```

Fastlane spaceship will prompt for a password for the apple id to log in to iTunes connect if it is not available.
It seems that fastlane match cannot always figure out when to re-use an existing certificate (February 2019) for a new provisioning profile.

Provisioning profiles are stored in

```shell
profiles/adhoc
profiles/appstore
profiles/development
profiles/enterprise
```

Fastlane match requires that provisioning profiles are named AdHoc_`bundle identifier`.mobileprovision, AppStore_`bundle identifier`.mobileprovision, Development_`bundle identifier`.mobileprovision or InHouse_`bundle identifier`.mobileprovision.

</details>

## Problems and trouble-shooting

- When you run `fastlane match` first time it will ask you to enter the password from Apple developer center. This password is stored in iOS team's 1Password vault. If you used the wrong password you will not be asked to change it. You then need to go to your keychain, find the entry for this password (searching for `fastlane`) and delete it. After that next time you run `faslane match` it will ask you for the password again.

- There were some problems (March 2019) with running `bundle exec fastlane spaceship`, it struggled to install the `pry` gem. This might be related to your shell version and a possible workaround is to install manually in the `~/.fastlane` folder.

- If you are making enterprise or AppStore build locally and signing fails make sure that you have only one distribution certificate in your keychain as match can confuse them and pick the first one in the list that might not be what you need. Delete the certificate that you don't need (i.e. only leave AppStore certificate if you are making AppStore build). If you will need this certificate later you'll be able to donwload it again.
